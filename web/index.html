<!doctype html>
<html lang="es" data-bs-theme="dark">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>AI Agent · Consola & Métricas</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    body{background:#0b0f14}
    .card-sci{background:#0d1117;border:1px solid #1f2937}
    .terminal{font-family:ui-monospace,SFMono-Regular,Menlo,monospace}
    .msg{white-space:pre-wrap}
    .msg-user{background:#0b2239;border:1px solid #163a5f}
    .msg-bot{background:#111827;border:1px solid #1f2937}
    .divider{height:1px;background:linear-gradient(90deg,transparent,#1f2937,transparent)}
    .metric{font-variant-numeric:tabular-nums}
  </style>
</head>
<body>
<div class="container-fluid py-4">
  <div class="row g-4">
    <!-- CHAT -->
    <div class="col-xxl-8">
      <div class="card card-sci">
        <div class="card-header d-flex justify-content-between align-items-center terminal">
          <div>
            <span class="badge text-bg-primary">AI Agent Console</span>
            <span class="text-secondary ms-2">Bootstrap · Chart.js</span>
          </div>
          <span id="statusDot" class="badge rounded-pill text-bg-secondary">Listo</span>
        </div>
        <div class="card-body" id="chatPane" style="height: 64vh; overflow:auto;">
          <div class="text-secondary small">Conectado al backend. Envía un mensaje abajo.</div>
          <div class="divider my-3"></div>
        </div>
        <div class="card-footer">
          <form id="chatForm" class="row g-2">
            <div class="col-lg-8">
              <input id="prompt" class="form-control" placeholder="Escribe tu mensaje…" autocomplete="off">
            </div>
            <div class="col-lg-2">
              <select id="target" class="form-select">
                <option value="auto" selected>auto</option>
                <option value="langgraph">langgraph</option>
                <option value="openai">openai</option>
                <option value="rag">rag</option>
              </select>
            </div>
            <div class="col-lg-2 d-grid">
              <button class="btn btn-primary" type="submit">Enviar</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- MÉTRICAS -->
    <div class="col-xxl-4">
      <div class="card card-sci mb-4">
        <div class="card-header terminal">Configuración</div>
        <div class="card-body">
          <label class="form-label small text-secondary">Agent Base URL</label>
          <input id="baseUrl" class="form-control mb-2" value="http://localhost:8090/chat">
          <div class="form-text">El panel solo usa métricas del JSON de respuesta (campo <code>data.usage</code>).</div>
        </div>
      </div>

      <div class="card card-sci mb-4">
        <div class="card-header terminal">Métrica (última respuesta)</div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-6">
              <div class="small text-secondary">Prompt tokens</div>
              <div class="h4 metric" id="promptTokens">–</div>
            </div>
            <div class="col-6">
              <div class="small text-secondary">Completion tokens</div>
              <div class="h4 metric" id="completionTokens">–</div>
            </div>
            <div class="col-12">
              <div class="small text-secondary">Total tokens</div>
              <div class="h4 metric" id="totalTokens">–</div>
            </div>
          </div>
          <div class="divider my-3"></div>
          <details>
            <summary class="text-secondary">Detalles (si vienen)</summary>
            <pre class="mt-2 small text-body-secondary" id="usageDetails">—</pre>
          </details>
        </div>
      </div>

      <div class="card card-sci">
        <div class="card-header terminal">Acumulados (sesión)</div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-6">
              <div class="small text-secondary">Mensajes</div>
              <div class="h4 metric" id="accMsgs">0</div>
            </div>
            <div class="col-6">
              <div class="small text-secondary">Total tokens</div>
              <div class="h4 metric" id="accTotalTokens">0</div>
            </div>
            <div class="col-6">
              <div class="small text-secondary">Prompt tokens</div>
              <div class="h5 metric" id="accPromptTokens">0</div>
            </div>
            <div class="col-6">
              <div class="small text-secondary">Completion tokens</div>
              <div class="h5 metric" id="accCompletionTokens">0</div>
            </div>
          </div>
          <div class="divider my-3"></div>
          <canvas id="tokensChart" height="160"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // ---------------- State ----------------
  const state = {
    accMsgs: 0,
    accPrompt: 0,
    accCompletion: 0,
    accTotal: 0,
    history: [] // {ts,label,prompt,completion,total}
  };

  // --------------- UI refs ----------------
  const chatPane = document.getElementById('chatPane');
  const statusDot = document.getElementById('statusDot');
  const baseUrlInput = document.getElementById('baseUrl');
  const form = document.getElementById('chatForm');
  const promptInput = document.getElementById('prompt');
  const targetSelect = document.getElementById('target');

  const promptTokens = document.getElementById('promptTokens');
  const completionTokens = document.getElementById('completionTokens');
  const totalTokens = document.getElementById('totalTokens');
  const usageDetails = document.getElementById('usageDetails');

  const accMsgs = document.getElementById('accMsgs');
  const accPromptTokens = document.getElementById('accPromptTokens');
  const accCompletionTokens = document.getElementById('accCompletionTokens');
  const accTotalTokens = document.getElementById('accTotalTokens');

  // --------------- Helpers ----------------
  function addMsg(role, text){
    const wrapper = document.createElement('div');
    wrapper.className = 'mb-3';
    const bubble = document.createElement('div');
    bubble.className = 'p-3 rounded msg ' + (role==='user' ? 'msg-user' : 'msg-bot');
    bubble.textContent = text;
    wrapper.appendChild(bubble);
    chatPane.appendChild(wrapper);
    chatPane.scrollTop = chatPane.scrollHeight;
  }
  function setStatus(text, ok=true){
    statusDot.textContent = text;
    statusDot.className = 'badge rounded-pill ' + (ok ? 'text-bg-success' : 'text-bg-secondary');
  }

  // --------------- Chart ------------------
  const ctx = document.getElementById('tokensChart').getContext('2d');
  const tokensChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: [],
      datasets: [
        {label: 'Prompt', data: [], tension: 0.25},
        {label: 'Completion', data: [], tension: 0.25},
        {label: 'Total', data: [], tension: 0.25}
      ]
    },
    options: {
      responsive: true,
      scales: {
        x: {grid: {display:false}},
        y: {grid: {color:'#1f2937'}}
      },
      plugins: { legend: { labels: { color:'#cbd5e1' } } }
    }
  });
  function pushPoint(label, p, c, t){
    tokensChart.data.labels.push(label);
    tokensChart.data.datasets[0].data.push(p||0);
    tokensChart.data.datasets[1].data.push(c||0);
    tokensChart.data.datasets[2].data.push(t||0);
    if(tokensChart.data.labels.length>50){
      tokensChart.data.labels.shift();
      tokensChart.data.datasets.forEach(d=>d.data.shift());
    }
    tokensChart.update('none');
  }

  // --------------- Submit -----------------
  form.addEventListener('submit', async(e)=>{
    e.preventDefault();
    const text = promptInput.value.trim();
    if(!text) return;
    addMsg('user', text);
    promptInput.value = '';

    const url = baseUrlInput.value.trim() || 'http://localhost:8090/chat';
    const target = targetSelect.value;

    setStatus('Enviando…', false);

    try{
      const resp = await fetch(url, {
        method:'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ message: text, target })
      });
      const data = await resp.json();
      if(!resp.ok || !data.ok){
        setStatus('Error', false);
        addMsg('bot', '⚠️ Error: ' + (data.detail || 'Solicitud fallida'));
        return;
      }
      setStatus('OK', true);

      // Extract content & usage ONLY from response (no métricas del cliente)
      const content = data?.data?.content ?? '';
      const usage = data?.data?.usage ?? {};
      const p = Number(usage?.prompt_tokens ?? 0);
      const c = Number(usage?.completion_tokens ?? 0);
      const t = Number(usage?.total_tokens ?? (p+c));

      // Mostrar mensaje del agente
      addMsg('bot', content || '[respuesta vacía]');

      // Última métrica
      promptTokens.textContent = Number.isFinite(p) ? p : '–';
      completionTokens.textContent = Number.isFinite(c) ? c : '–';
      totalTokens.textContent = Number.isFinite(t) ? t : '–';
      usageDetails.textContent = JSON.stringify(usage, null, 2);

      // Acumulados de la sesión
      state.accMsgs += 1;
      state.accPrompt += (Number.isFinite(p) ? p : 0);
      state.accCompletion += (Number.isFinite(c) ? c : 0);
      state.accTotal += (Number.isFinite(t) ? t : 0);

      accMsgs.textContent = state.accMsgs;
      accPromptTokens.textContent = state.accPrompt;
      accCompletionTokens.textContent = state.accCompletion;
      accTotalTokens.textContent = state.accTotal;

      // Serie temporal
      const label = new Date().toLocaleTimeString();
      state.history.push({ts:Date.now(), label, prompt:p, completion:c, total:t});
      pushPoint(label, p, c, t);

    } catch(err){
      setStatus('Error', false);
      addMsg('bot', '⚠️ Error de red o CORS. Revisa la URL del backend.');
      console.error(err);
    }
  });
</script>
</body>
</html>
